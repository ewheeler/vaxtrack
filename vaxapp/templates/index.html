{% extends "layout-split-2.html" %}

{% block title %}Dashboard{% endblock %}
{% block javascripts %}
{{ block.super }}
<script type="text/javascript">

$(document).ready(function(){

    var options = new Array("B","F","P");
    var vaccine = "BCG";
    var country = "ML";
    var chart_name = "";

    $("#plot_options :input").val(["B","F","P"]);
    $("#vaccines :input").val(["BCG"]);
    $("#country").val("ML");
    get_chart();
    get_alerts();
    get_stats();

    $("#plot_options :input").click(function(){
        options = new Array();
	$("#plot_options :input:checked").each(function() {
	    options.push( $(this).val() );
	});
        get_chart();
    });

    $("#vaccines :input").click(function(){
        vaccine = ""; 
	$("#vaccines :input:radio:checked").each(function() {
	    vaccine = $(this).val();
	});
        get_chart();
    });

    $("#country").change(function(){
        country = "";
	country = $(this).val();
        get_chart();
	get_alerts();
	get_stats();
    });

    function get_chart(){
	chart_opts = options.sort().join("");
        vaccine = vaccine.replace(/-/g, "_");
        chart_name = country + "/" + vaccine + "/" + chart_opts + ".png";
        $("#chart").attr('src', "/charts/" + chart_name);
        $("#flag").attr('src', "/assets/icons/bandiere/" + country.toLowerCase() + ".gif");
    };

    function get_alerts(){
	$.get("/alerts/" + country + "/" + vaccine, function (data){
		$("#alerts li").remove();
		var alerts;
		alerts = jQuery.parseJSON(data);
		if (alerts.length < 1){
			$("#module-info").hide();
		} else {
			$("#module-info").show();
		}
		for (a in alerts){
			$("#alerts").append("<li class='" + alerts[a].fields.status + "'>" + alerts[a].fields.text + "</li>");
		}
	});
    };
    function get_stats(){
	$.get("/stats/" + country + "/" + vaccine, function (data){
		$("#stats tbody tr").remove();
		$("#hist tbody tr").remove();
		var stats;
		stats = jQuery.parseJSON(data);
		if (stats.length < 1){
			$("#module-stats").hide();
			$("#module-hist").hide();
		} else {
			$("#module-stats").show();
			$("#module-hist").show();
		}
		for (s in stats){
			$("#stats > tbody:last").append("<tr><td>" + 'est. daily cons.:</td><td>' + stats[s].est_daily_cons+ "</td></tr>");
			$("#stats > tbody:last").append("<tr><td>" + 'days of stock:</td><td>' + stats[s].days_of_stock + "</td></tr>");
			$("#stats > tbody:last").append("<tr><td>" + 'coverage of annual need:</td><td>' + stats[s].percent_coverage + "</td></tr>");
			$("#stats > tbody:last").append("<tr><td>" + "doses delivered this year:</td><td>" + stats[s].doses_delivered_this_year + "</td></tr>");
			$("#stats > tbody:last").append("<tr><td>" + "doses on order:</td><td>" + stats[s].doses_on_orders + "</td></tr>");
			$("#stats > tbody:last").append("<tr><td>" + "reference date:</td><td>" + stats[s].reference_date + "</td></tr>");
			$("#stats > tbody:last").append("<tr><td>" + "analysis date:</td><td>" + stats[s].analyzed + "</td></tr>");

			var first_row;
			first_row = "<tr><td style='font-size:.66em;'><em>Note: first and last year totals may not reflect full 12 months</em></td>"
			for (y in stats[s].years){
				first_row = first_row + "<td>" + stats[s].years[y] + "</td>"	
			}
			$("#hist > tbody:last").append(first_row + "</tr>")

			var consumed_in_year_row;
			consumed_in_year_row = "<tr><td>total consumed</td>"
			for (y in stats[s].years){
				consumed_in_year_row = consumed_in_year_row + "<td>" + stats[s].consumed_in_year[y] + "</td>"
			}
			$("#hist > tbody:last").append(consumed_in_year_row + "</tr>")

			var annual_demand;
			annual_demand = "<tr><td>annual demand</td>"
			for (y in stats[s].years){
				annual_demand = annual_demand + "<td>" + stats[s].annual_demand[y] + "</td>"
			}
			$("#hist > tbody:last").append(annual_demand + "</tr>")

			var actual_cons_rate;
			actual_cons_rate = "<tr><td>actual daily cons. rate</td>"
			for (y in stats[s].years){
				actual_cons_rate = actual_cons_rate + "<td>" + stats[s].actual_cons_rate[y] + "</td>"
			}
			$("#hist > tbody:last").append(actual_cons_rate + "</tr>")

			var three_by_year;
			three_by_year = "<tr><td>buffer stock level</td>"
			for (y in stats[s].years){
				three_by_year = three_by_year + "<td>" + stats[s].three_by_year[y] + "</td>"
			}
			$("#hist > tbody:last").append(three_by_year + "</tr>")

			var nine_by_year;
			nine_by_year = "<tr><td>overstock level</td>"
			for (y in stats[s].years){
				nine_by_year = nine_by_year + "<td>" + stats[s].nine_by_year[y] + "</td>"
			}
			$("#hist > tbody:last").append(nine_by_year + "</tr>")

			}
	});
    };
});
</script>
{% endblock %}

{% block left %}
    {% if countries %}
    <div class="module expanded">
        <h3>Chart options</h3>
        <div id="vaxform">
            <h5>Country</h5>
            <form id="countries" action="">
                <select id="country">
                {% for c in countries %}
                        <option value="{{c.pk}}">{{c.printable_name}}</option>
                {% endfor %}
                </select>
                <img id="flag" src="">
            </form>
            <h5>Vaccine</h5>
            <form id="vaccines" action="">
                {% for v in vaccines %}
                        <input type="radio" name="vax" id="radio-{{ v.slug }}" value="{{ v.slug }}"/>
                        <label for="radio-{{ v.slug }}"> {{ v.abbr }} </label><br />
                {% endfor %}
            </form>
            <h5>Plot</h5>
            <form id="plot_options" action="">
                <input type="checkbox" id="checkbox-B" value="B" checked="checked" />
                <label for="checkbox-B">buffer stock  &amp; overstock indicators</label><br />
                <input type="checkbox" id="checkbox-F" value="F" checked="checked" />
                <label for="checkbox-F">forecasted stock level (CO forecast)</label><br />
                <input type="checkbox" id="checkbox-P" value="P" checked="checked" />
                <label for="checkbox-F">forecasted stock level (with POs)</label><br />
                <input type="checkbox" id="checkbox-C" value="C" checked="checked" />
                <label for="checkbox-F">projected stock level (CO forecast)</label><br />
                <input type="checkbox" id="checkbox-U" value="U" checked="checked" />
                <label for="checkbox-F">projected stock level (with deliveries)</label><br />
            </form>
        </div>
    </div>
    {% endif %}
    <div class="module expanded" id="module-info">
        <h3>Alerts</h3>
	<ul id='alerts'>
	</ul>
    </div>
    <div class="module expanded" id="module-stats">
        <h3>Details</h3>
	<table id='stats' border='0' cellpadding='0' cellspacing='0'>
		<tbody>
		</tbody>
	</table>
    </div>
    <div class="module expanded" id="module-hist">
        <h3>Historical</h3>
	<table id='hist' border='0' cellpadding='0' cellspacing='0'>
		<tbody>
		</tbody>
	</table>
    </div>
{% endblock %}

{% block right %}
    <div class="module">
        <h3>Chart</h3>
        <img id="chart" src="">
        <div class="toolbar">
        </div>
    </div>
{% endblock %}
